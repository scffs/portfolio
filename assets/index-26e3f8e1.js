var t=Object.defineProperty,e=Object.defineProperties,n=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,l=(e,n,o)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[n]=o,s=(t,e)=>{for(var n in e||(e={}))i.call(e,n)&&l(t,n,e[n]);if(o)for(var n of o(e))a.call(e,n)&&l(t,n,e[n]);return t},r=(t,o)=>e(t,n(o)),d=(t,e)=>{var n={};for(var l in t)i.call(t,l)&&e.indexOf(l)<0&&(n[l]=t[l]);if(null!=t&&o)for(var l of o(t))e.indexOf(l)<0&&a.call(t,l)&&(n[l]=t[l]);return n},c=(t,e,n)=>(l(t,"symbol"!=typeof e?e+"":e,n),n);import{_ as u,j as p}from"./index-41a51a4c.js";import{i as h,h as m,x as g,C as v,Y as M,P as f,Z as E,$ as y,a0 as x,a1 as S,c as C,W as w,f as T,w as O,a2 as R,F as _,H as P,a3 as Y}from"./AppWrapper-fa8f88ad.js";import{r as k}from"./react-37698f52.js";import{M as A,b as F,a as b}from"./App-a8039ade.js";import{g as D,t as H,u as j,a as I}from"./useWaitTransitionFinish-5642122b.js";import{F as q,w as L}from"./FocusTrap-cd36a281.js";function G(t){return"function"==typeof t}var N,$;function B(t,e){if("setActive"===e.type&&e.id!==t.activeModal){const n=e.id,o=t.exitingModal||t.activeModal;let i=t.history?[...t.history]:[];const a=Boolean(n&&i.includes(n));return null===n?i=[]:a?i=i.splice(0,i.indexOf(n)+1):i.push(n),{activeModal:n,enteringModal:null,exitingModal:o,history:i,isBack:a}}return"entered"===e.type&&e.id===t.enteringModal?r(s({},t),{enteringModal:null}):"exited"===e.type&&e.id===t.exitingModal?r(s({},t),{exitingModal:null}):"inited"===e.type&&e.id===t.activeModal?r(s({},t),{enteringModal:e.id}):t}function z(t,e,n=g,o=g,i=g,a=g,l=g){const d=k.useRef({}).current;(function(t){return k.Children.toArray(t)})(e).forEach((t=>{const e=t.props,n=D(e),o=void 0!==n&&d[n]||{id:null!=n?n:null};o.onOpen=t.props.onOpen,o.onOpened=t.props.onOpened,o.onClose=t.props.onClose,o.onClosed=t.props.onClosed,"number"==typeof e.settlingHeight&&(o.settlingHeight=e.settlingHeight),null!==o.id&&(d[o.id]=o)}));const c=t&&!d[t]?null:t,[u,p]=k.useReducer(B,{activeModal:c,enteringModal:null,exitingModal:null,history:c?[c]:[],isBack:!1});m((()=>{p({type:"setActive",id:null!=c?c:null})}),[t]),m((()=>{u.activeModal&&(l(d[u.activeModal]),p({type:"inited",id:u.activeModal}))}),[u.activeModal]);const h=t=>{var e;return null!=t&&(null==(e=d[t])?void 0:e.type)===N.CARD},v=k.useCallback((t=>{if(t){const e=d[t];G(e.onOpened)?e.onOpened():G(o)&&o(t)}p({type:"entered",id:t})}),[d,o]),M=k.useCallback((t=>{if(t){const e=d[t];G(e.onClosed)?e.onClosed():G(a)&&a(t)}p({type:"exited",id:t})}),[d,a]),f=Boolean(u.exitingModal&&(h(t)||h(u.exitingModal))),E=k.useCallback((t=>t?d[t]:void 0),[d]);return r(s({onEnter:function(){const t=u.activeModal&&d[u.activeModal];t&&(G(t.onOpen)?t.onOpen():G(n)&&t.id&&n(t.id))},onEntered:v,onExit:function(){const t=u.activeModal&&d[u.activeModal];t&&(G(t.onClose)?t.onClose():G(i)&&t.id&&i(t.id))},onExited:M},u),{delayEnter:f,getModalState:E})}($=N||(N={})).PAGE="page",$.CARD="card";const W="_ModalRoot_192qo_1",V="_ModalRoot__mask_192qo_6",K="_ModalRoot--touched_192qo_22",U="_ModalRoot--switching_192qo_26",Z="_ModalRoot__viewport_192qo_31",J="_ModalRoot--desktop_192qo_40",Q="_ModalRoot--vkapps_192qo_44",X="_ModalRoot__modal_192qo_50",tt=L("ModalRoot");function et(t,e){return!!e&&(t>=e[0]&&t<=e[1])}function nt(t){return y(t,0,98)}class ot extends k.Component{constructor(t){super(t),c(this,"documentScrolling",!1),c(this,"maskElementRef"),c(this,"viewportRef",k.createRef()),c(this,"maskAnimationFrame"),c(this,"modalRootContext"),c(this,"frameIds"),c(this,"restoreFocusTo"),c(this,"preventTouch",(t=>{if(!t)return!1;for(;t.originalEvent;)t=t.originalEvent;return t.preventDefault&&t.preventDefault(),!1})),c(this,"updateModalHeight",(()=>{const t=this.props.getModalState(this.props.activeModal);t&&t.type===N.PAGE&&(this.props.enteringModal?this.waitTransitionFinish(t,(()=>{requestAnimationFrame((()=>this.checkPageContentHeight()))})):requestAnimationFrame((()=>this.checkPageContentHeight())))})),c(this,"onTouchMove",(t=>{if(this.props.exitingModal)return;const e=this.props.getModalState(this.props.activeModal);return e?e.type===N.PAGE?this.onPageTouchMove(t,e):e.type===N.CARD?this.onCardTouchMove(t,e):void 0:void 0})),c(this,"onTouchEnd",(t=>{const e=this.props.getModalState(this.props.activeModal);return(null==e?void 0:e.type)===N.PAGE?this.onPageTouchEnd(t,e):(null==e?void 0:e.type)===N.CARD?this.onCardTouchEnd(t,e):void 0})),c(this,"onScroll",(t=>{var e;const n=this.props.activeModal,o=t.target;if(!n)return;const i=this.props.getModalState(n);(null==i?void 0:i.type)===N.PAGE&&(null==(e=null==i?void 0:i.contentElement)?void 0:e.contains(o))&&(i.contentScrolled=!0,i.contentScrollStopTimeout&&clearTimeout(i.contentScrollStopTimeout),i.contentScrollStopTimeout=setTimeout((()=>{i.contentScrolled&&(i.contentScrolled=!1)}),250))})),this.state={touchDown:!1,dragging:!1,modalOpenedLog:[]},this.maskElementRef=k.createRef(),this.modalRootContext={updateModalHeight:this.updateModalHeight,registerModal:t=>{var e,n=t,{id:o}=n,i=d(n,["id"]);return Object.assign(null!=(e=this.props.getModalState(o))?e:{},i)},onClose:()=>this.props.onExit(),isInsideModal:!0},this.frameIds={}}get timeout(){return this.props.platform===f.IOS?400:320}get document(){return this.props.document}get window(){return this.props.window}getModals(){return k.Children.toArray(this.props.children)}componentDidMount(){var t;null==(t=this.window)||t.addEventListener("resize",this.updateModalHeight,!1)}componentWillUnmount(){this.toggleDocumentScrolling(!0),this.window.removeEventListener("resize",this.updateModalHeight,!1)}componentDidUpdate(t){if(this.props.exitingModal&&this.props.exitingModal!==t.exitingModal&&this.closeModal(this.props.exitingModal),this.props.enteringModal&&this.props.enteringModal!==t.enteringModal){const{enteringModal:t}=this.props,e=this.props.getModalState(t);this.props.onEnter(),this.waitTransitionFinish(e,(()=>{(null==e?void 0:e.innerElement)&&(e.innerElement.style.transitionDelay=""),this.props.onEntered(t)})),(null==e?void 0:e.innerElement)&&(e.innerElement.style.transitionDelay=this.props.delayEnter?`${this.timeout}ms`:"",this.animateTranslate(e,e.translateY))}this.props.activeModal&&!t.activeModal&&(this.restoreFocusTo=this.document.activeElement),this.props.activeModal||this.props.exitingModal||!this.restoreFocusTo||(this.restoreFocusTo.focus(),this.restoreFocusTo=null),this.toggleDocumentScrolling(!this.props.activeModal&&!this.props.exitingModal)}toggleDocumentScrolling(t){this.documentScrolling!==t&&(this.documentScrolling=t,t?this.window.removeEventListener("touchmove",this.preventTouch,{passive:!1}):this.window.addEventListener("touchmove",this.preventTouch,{passive:!1}))}checkPageContentHeight(){const t=this.props.getModalState(this.props.activeModal);if((null==t?void 0:t.type)===N.PAGE&&(null==t?void 0:t.modalElement)){const e=s({},t);lt(t);const n=s({},t);let o=!1;e.expandable===n.expandable?e.translateYFrom!==n.translateYFrom&&(o=!0):o=!0,o&&this.animateTranslate(t,t.translateY)}}closeModal(t){var e,n,o;this.setState({touchDown:!1});const i=this.props.getModalState(t);if(!i)return void(t&&tt(`closeActiveModal: модальное окно (страница) ${t} не существует`,"error"));this.state.modalOpenedLog.length||this.setState((e=>({modalOpenedLog:[...e.modalOpenedLog,t]})));const a=this.props.getModalState(this.props.activeModal),l=!!a&&a.type===N.PAGE,s=!!i&&i.type===N.PAGE;this.waitTransitionFinish(i,(()=>this.props.onExited(t)));const r=s&&l&&(null!=(e=i.translateY)?e:0)<=(null!=(n=null==a?void 0:a.translateYFrom)?n:0)&&!this.props.isBack?(null!=(o=null==a?void 0:a.translateYFrom)?o:0)+10:100;this.animateTranslate(i,r),a?a.id&&!this.state.modalOpenedLog.includes(a.id)&&(a.translateY=void 0,this.setState((t=>({modalOpenedLog:[...t.modalOpenedLog,a.id]})))):(this.setMaskOpacity(i,0),this.setState({modalOpenedLog:[]}),i.translateY=void 0)}onPageTouchMove(t,e){var n,o,i,a,l,s;const{shiftY:r,originalEvent:d}=t,c=d.target;if(!t.isY)return void((null==(n=this.viewportRef.current)?void 0:n.contains(c))&&d.preventDefault());if(!(null==(o=e.innerElement)?void 0:o.contains(c)))return d.preventDefault();d.stopPropagation();const{expandable:u,contentScrolled:p,collapsed:h,expanded:m}=e;if(this.state.touchDown||(e.touchStartContentScrollTop=null!=(a=null==(i=e.contentElement)?void 0:i.scrollTop)?a:0,this.setState({touchDown:!0})),!p&&(null===e.touchMovePositive&&(e.touchMovePositive=r>0),!e.expandable||h||m&&e.touchMovePositive&&0===e.touchStartContentScrollTop||(null==(l=e.headerElement)?void 0:l.contains(c)))){if(d.preventDefault(),!u&&r<0||!this.window)return;!this.state.dragging&&this.setState({dragging:!0});const t=r/this.window.innerHeight*100,n=E(t,72,.8,this.props.platform!==f.IOS);e.touchShiftYPercent=t,e.translateYCurrent=nt((null!=(s=e.translateY)?s:0)+n),this.animateTranslate(e,e.translateYCurrent),this.setMaskOpacity(e)}}onCardTouchMove(t,e){var n,o;const{originalEvent:i,shiftY:a}=t,l=i.target;if(null==(n=e.innerElement)?void 0:n.contains(l)){this.state.touchDown||this.setState({touchDown:!0,dragging:!0});const t=a/e.innerElement.offsetHeight*100,n=E(t,72,1.2,this.props.platform!==f.IOS);e.touchShiftYPercent=t,e.translateYCurrent=Math.max(0,(null!=(o=e.translateY)?o:0)+n),this.animateTranslate(e,e.translateYCurrent),this.setMaskOpacity(e)}}onPageTouchEnd(t,e){var n,o,i,a,l,s;const{startY:r,shiftY:d}=t;let c;if(e.contentScrolled=!1,e.touchMovePositive=null,this.state.dragging&&this.window){const u=(r+d)/this.window.innerHeight*100;let p=null!=(n=e.translateYCurrent)?n:0;p=nt(p+p/t.duration*240*.6*((null!=(o=e.touchShiftYPercent)?o:0)<0?-1:1)),p=100!==e.settlingHeight?et(p,e.expandedRange)?null!=(a=null==(i=e.expandedRange)?void 0:i[0])?a:0:et(p,e.collapsedRange)?null!=(l=e.translateYFrom)?l:0:et(p,e.hiddenRange)?100:null!=(s=e.translateYFrom)?s:0:et(p,[0,25])?0:100,100!==p&&u>=75&&(p=100),e.translateY=p,e.translateYCurrent=p,e.collapsed=p>0&&p<u,e.expanded=0===p,e.hidden=100===p,e.hidden&&this.props.onExit(),c=()=>{e.hidden||this.animateTranslate(e,e.translateY),this.setMaskOpacity(e)}}this.setState({touchDown:!1,dragging:!1},c)}onCardTouchEnd({duration:t},e){var n,o;let i;if(this.state.dragging){let a=null!=(n=e.translateYCurrent)?n:0;const l=a/t*240*.6*((null!=(o=e.touchShiftYPercent)?o:0)<0?-1:1);a=Math.max(0,a+l),a=a>=30?100:0,e.translateY=a,e.hidden=100===a,e.hidden&&this.props.onExit(),i=()=>{e.hidden||this.animateTranslate(e,e.translateY),this.setMaskOpacity(e)}}this.setState({touchDown:!1,dragging:!1},i)}waitTransitionFinish(t,e){var n;if(H.supported){const o=()=>{var n;null==(n=null==t?void 0:t.innerElement)||n.removeEventListener(H.name,o),e()};null==(n=null==t?void 0:t.innerElement)||n.addEventListener(H.name,o)}else setTimeout(e,this.timeout)}animateTranslate(t,e){const n=`animateTranslateFrame${t.id}`;cancelAnimationFrame(this.frameIds[n]),this.frameIds[n]=requestAnimationFrame((()=>{var n,o;n=t.innerElement,o=`translate3d(0, ${e}%, 0)`,n&&(n.style.transform=o,n.style.webkitTransform=o)}))}setMaskOpacity(t,e=null){var n;null===e&&(null==(n=this.props.history)?void 0:n[0])!==t.id||(this.maskAnimationFrame&&cancelAnimationFrame(this.maskAnimationFrame),this.maskAnimationFrame=requestAnimationFrame((()=>{if(this.maskElementRef.current){const{translateY:n=0,translateYCurrent:o=0}=t,i=null===e?1-(o-n)/(100-n)||0:e;this.maskElementRef.current.style.opacity=y(i,0,100).toString()}})))}render(){var t;const{activeModal:e,exitingModal:n,enteringModal:o}=this.props,{touchDown:i,dragging:a}=this.state;return e||n?k.createElement(x.Provider,{value:!0},k.createElement(A.Provider,{value:this.modalRootContext},k.createElement(S,{className:C(W,(null==(t=this.props.configProvider)?void 0:t.webviewType)===w.VKAPPS&&Q,i&&C(K,"vkuiInternalModalRoot--touched"),!(!o&&!n)&&C(U,"vkuiInternalModalRoot--switching")),onMove:this.onTouchMove,onEnd:this.onTouchEnd,onScroll:this.onScroll},k.createElement("div",{className:V,onClick:this.props.onExit,ref:this.maskElementRef}),k.createElement("div",{className:Z,ref:this.viewportRef},this.getModals().map((t=>{const o=D(t.props),i=this.props.getModalState(o);if(o!==e&&o!==n||!i)return null;const l=s({},i),r=l.type===N.PAGE,d=`modal-${o}`;return k.createElement(q,{key:d,getRootRef:t=>{const e=this.props.getModalState(o);e&&(e.modalElement=t)},onClose:this.props.onExit,timeout:this.timeout,className:C(X,a&&"vkuiInternalModalRoot__modal--dragging",r&&l.expandable&&"vkuiInternalModalRoot__modal--expandable",r&&l.collapsed&&"vkuiInternalModalRoot__modal--collapsed"),restoreFocus:!1},t)})))))):null}}const it=function(t,e,n){return function(o){const i=k.useContext(e);return k.createElement(t,r(s({},o),{[n]:i}))}}((at=M(function(t=g){return function(e){return function(n){const o=z(n.activeModal,n.children,n.onOpen,n.onOpened,n.onClose,n.onClosed,t);return k.createElement(e,s(s({},n),o))}}}((function(t){switch(t.type){case N.PAGE:return t.settlingHeight=t.settlingHeight||75,lt(t);case N.CARD:return function(t){t.translateY=0}(t)}}))(ot)),function(t){const{platform:e}=h();return k.createElement(at,r(s({},t),{platform:e}))}),v,"configProvider");var at;function lt(t){var e,n,o,i,a,l,s;const{contentElement:r}=t,d=(null==r?void 0:r.firstElementChild).offsetHeight;let c=t.translateY;t.expandable=d>(null!=(e=null==r?void 0:r.clientHeight)?e:0)||100===t.settlingHeight||t.expanded;let u,p,h,m,g,v=!1,M=!1;if(t.expandable){u=100-(null!=(n=t.settlingHeight)?n:0);const e=u/2,o=100-u;h=[0,e],m=[e,u+o/4],g=[u+o/4,100],v=u>0,M=u<=0,p=u}else{u=100-(d+(null!=(i=null==(o=t.headerElement)?void 0:o.offsetHeight)?i:0))/(null!=(s=null==(l=null==(a=t.innerElement)?void 0:a.parentElement)?void 0:l.offsetHeight)?s:0)*100,p=u,h=[p,p+25],m=[p+25,p+25],g=[p+25,p+100]}(t.expandable&&p>(null!=c?c:100)||100===t.settlingHeight)&&(p=0),0===p&&(M=!0,v=!1),t.expandedRange=h,t.collapsedRange=m,t.hiddenRange=g,t.translateY=p,t.translateYFrom=u,t.collapsed=v,t.expanded=M}const st=({activeModal:t,children:e,onOpen:n,onOpened:o,onClose:i,onClosed:a})=>{const l=k.useRef(null),s=k.useRef(void 0),r=k.useRef(void 0),{document:c}=T(),{webviewType:u,platform:p}=h(),{activeModal:m,exitingModal:v,onExit:M,getModalState:E,enteringModal:x,onEnter:S,onEntered:R,onExited:_,history:P,delayEnter:Y}=z(t,e,n,o,i,a,g),{waitTransitionFinish:F}=j(),b=I({exitingModal:v,enteringModal:x,activeModal:m}),H=O({updateModalHeight:()=>{},registerModal:t=>{var e,n=t,{id:o}=n,i=d(n,["id"]);return Object.assign(null!=(e=E(o))?e:{},i)},onClose:M,isInsideModal:!0}),L=p===f.IOS?400:320,G=k.Children.toArray(e),N=(t,e)=>{(null==t?void 0:t.innerElement)&&(t.innerElement.style.transition="",t.innerElement.style.transitionDelay=e&&Y?`${L}ms`:"",t.innerElement.style.opacity=e?"1":"0")},$=t=>{const e=E(t);e&&(m?_(t):requestAnimationFrame((()=>{F(null==e?void 0:e.innerElement,(()=>_(t)),L),N(e,!1),((t,e=null)=>{null===e&&(null==P?void 0:P[0])!==t.id||(s.current&&cancelAnimationFrame(s.current),s.current=requestAnimationFrame((()=>{if(l.current){const{translateY:n=0,translateYCurrent:o=0}=t,i=null===e?1-(o-n)/(100-n)||0:e;l.current.style.opacity=y(i,0,100).toString()}})))})(e,0)})))};return k.useEffect((()=>{var t;b&&(v&&v!==b.exitingModal&&$(v),x&&x!==b.enteringModal&&(()=>{if(!x||!b)return;const t=E(x);S(),b.exitingModal?((null==t?void 0:t.innerElement)&&(t.innerElement.style.transition="none",t.innerElement.style.opacity="1"),R(x)):requestAnimationFrame((()=>{x==x&&(F(null==t?void 0:t.innerElement,(()=>R(x)),L),N(t,!0))}))})(),m&&!b.activeModal&&(r.current=null!=(t=null==c?void 0:c.activeElement)?t:void 0),m||v||!r.current||(r.current.focus(),r.current=void 0))})),m||v?k.createElement(A.Provider,{value:H},k.createElement("div",{className:C(W,u===w.VKAPPS&&Q,J)},k.createElement("div",{className:V,ref:l,onClick:M}),k.createElement("div",{className:Z},G.map((t=>{const e=D(t.props);if(e!==m&&e!==v)return null;const n=`modal-${e}`;return k.createElement(q,{restoreFocus:!1,onClose:M,timeout:L,key:n,className:X},t)}))))):null},rt=t=>{const{isDesktop:e}=F();R(!!t.activeModal);const n=e?st:it;return k.createElement(n,t)},dt=k.lazy((()=>u((()=>import("./FullstackModal-e30ff601.js")),["assets/FullstackModal-e30ff601.js","assets/index-41a51a4c.js","assets/react-37698f52.js","assets/index-1d7a8baa.css","assets/AppWrapper-fa8f88ad.js","assets/AppWrapper-00f658dd.css","assets/App-a8039ade.js","assets/App-cafd1bcd.css","assets/useWaitTransitionFinish-5642122b.js","assets/PanelHeaderButton-041684c9.js","assets/PanelHeaderButton-412d0c61.css","assets/Subhead-d9a283cd.js","assets/Subhead-1c6aa1fb.css","assets/FocusTrap-cd36a281.js","assets/FullstackModal-8e201c1c.css"]))),ct=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const t=_(),{modal:e}=b();return p.jsx(P,{id:"test",children:p.jsx(rt,{activeModal:e,onClose:()=>t.hideModal(),children:p.jsx(dt,{id:Y})})})}},Symbol.toStringTag,{value:"Module"}));export{N as M,ct as i};
