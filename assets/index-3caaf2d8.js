var t=Object.defineProperty,e=Object.defineProperties,n=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,l=(e,n,o)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[n]=o,s=(t,e)=>{for(var n in e||(e={}))i.call(e,n)&&l(t,n,e[n]);if(o)for(var n of o(e))a.call(e,n)&&l(t,n,e[n]);return t},r=(t,o)=>e(t,n(o)),d=(t,e)=>{var n={};for(var l in t)i.call(t,l)&&e.indexOf(l)<0&&(n[l]=t[l]);if(null!=t&&o)for(var l of o(t))e.indexOf(l)<0&&a.call(t,l)&&(n[l]=t[l]);return n},c=(t,e,n)=>(l(t,"symbol"!=typeof e?e+"":e,n),n);import{_ as u,j as p}from"./index-8e849d0e.js";import{e as h,f as m,q as v,$ as g,h as f,g as M,a0 as E,a1 as y,a2 as S,i as x,H as C,a3 as w,a4 as R,P as T,a5 as O,a6 as _,a7 as A,M as P,c as k,W as Y,y as F,a8 as b,D,Z as H,a9 as j}from"./AppWrapper-709c38ee.js";import{r as I}from"./react-37698f52.js";import{M as q,b as L,a as G}from"./App-7db3437f.js";import{g as N,t as $,u as B,a as z}from"./useWaitTransitionFinish-92d1af88.js";function K(t){return"function"==typeof t}const W=E.join(),V=t=>{var e=t,{Component:n="div",onClose:o,restoreFocus:i=!0,timeout:a=0,getRootRef:l,children:r}=e,c=d(e,["Component","onClose","restoreFocus","timeout","getRootRef","children"]);const u=h(l),{document:p,window:E}=m(),[x,C]=I.useState(null),[w,R]=I.useState(null),{keyboardInput:T}=I.useContext(v),O=g((()=>{var t;T&&!(null==(t=u.current)?void 0:t.contains(p.activeElement))&&(null==x?void 0:x.length)&&x[0].focus()}),a);f((()=>{O.set()}),[]),f((()=>{if(!u.current)return;const t=[];Array.prototype.forEach.call(u.current.querySelectorAll(W),(e=>{const{display:n,visibility:o}=E.getComputedStyle(e);"none"!==n&&"hidden"!==o&&t.push(e)})),0===t.length&&t.push(u.current),C(t)}),[r]);const _=g((()=>{w&&w.focus()}),a);f((()=>{if(i&&p.activeElement)return R(p.activeElement),()=>{_.set()}}),[i]);return M(p,"keydown",(t=>{if(y(t)===S.TAB&&(null==x?void 0:x.length)){const e=x.length-1,n=x.findIndex((e=>e===t.target)),o=-1===n||n===e&&!t.shiftKey;if(o||0===n&&t.shiftKey){t.preventDefault();const n=x[o?0:e];return n!==p.activeElement&&n.focus(),!1}}return o&&y(t)===S.ESCAPE&&o(),!0}),{capture:!0}),I.createElement(n,s({tabIndex:-1,ref:u},c),r)};var U,Z;function J(t,e){if("setActive"===e.type&&e.id!==t.activeModal){const n=e.id,o=t.exitingModal||t.activeModal;let i=t.history?[...t.history]:[];const a=Boolean(n&&i.includes(n));return null===n?i=[]:a?i=i.splice(0,i.indexOf(n)+1):i.push(n),{activeModal:n,enteringModal:null,exitingModal:o,history:i,isBack:a}}return"entered"===e.type&&e.id===t.enteringModal?r(s({},t),{enteringModal:null}):"exited"===e.type&&e.id===t.exitingModal?r(s({},t),{exitingModal:null}):"inited"===e.type&&e.id===t.activeModal?r(s({},t),{enteringModal:e.id}):t}function Q(t,e,n=C,o=C,i=C,a=C,l=C){const d=I.useRef({}).current;(function(t){return I.Children.toArray(t)})(e).forEach((t=>{const e=t.props,n=N(e),o=void 0!==n&&d[n]||{id:null!=n?n:null};o.onOpen=t.props.onOpen,o.onOpened=t.props.onOpened,o.onClose=t.props.onClose,o.onClosed=t.props.onClosed,"number"==typeof e.settlingHeight&&(o.settlingHeight=e.settlingHeight),null!==o.id&&(d[o.id]=o)}));const c=t&&!d[t]?null:t,[u,p]=I.useReducer(J,{activeModal:c,enteringModal:null,exitingModal:null,history:c?[c]:[],isBack:!1});f((()=>{p({type:"setActive",id:null!=c?c:null})}),[t]),f((()=>{u.activeModal&&(l(d[u.activeModal]),p({type:"inited",id:u.activeModal}))}),[u.activeModal]);const h=t=>{var e;return null!=t&&(null==(e=d[t])?void 0:e.type)===U.CARD},m=I.useCallback((t=>{if(t){const e=d[t];K(e.onOpened)?e.onOpened():K(o)&&o(t)}p({type:"entered",id:t})}),[d,o]),v=I.useCallback((t=>{if(t){const e=d[t];K(e.onClosed)?e.onClosed():K(a)&&a(t)}p({type:"exited",id:t})}),[d,a]),g=Boolean(u.exitingModal&&(h(t)||h(u.exitingModal))),M=I.useCallback((t=>t?d[t]:void 0),[d]);return r(s({onEnter:function(){const t=u.activeModal&&d[u.activeModal];t&&(K(t.onOpen)?t.onOpen():K(n)&&t.id&&n(t.id))},onEntered:m,onExit:function(){const t=u.activeModal&&d[u.activeModal];t&&(K(t.onClose)?t.onClose():K(i)&&t.id&&i(t.id))},onExited:v},u),{delayEnter:g,getModalState:M})}(Z=U||(U={})).PAGE="page",Z.CARD="card";const X="_ModalRoot_192qo_1",tt="_ModalRoot__mask_192qo_6",et="_ModalRoot--touched_192qo_22",nt="_ModalRoot--switching_192qo_26",ot="_ModalRoot__viewport_192qo_31",it="_ModalRoot--desktop_192qo_40",at="_ModalRoot--vkapps_192qo_44",lt="_ModalRoot__modal_192qo_50",st=function(t){const e=new Set;return(t,n="warn")=>{if(!e.has(t)){e.add(t)}}}();function rt(t,e){return!!e&&(t>=e[0]&&t<=e[1])}function dt(t){return _(t,0,98)}class ct extends I.Component{constructor(t){super(t),c(this,"documentScrolling",!1),c(this,"maskElementRef"),c(this,"viewportRef",I.createRef()),c(this,"maskAnimationFrame"),c(this,"modalRootContext"),c(this,"frameIds"),c(this,"restoreFocusTo"),c(this,"preventTouch",(t=>{if(!t)return!1;for(;t.originalEvent;)t=t.originalEvent;return t.preventDefault&&t.preventDefault(),!1})),c(this,"updateModalHeight",(()=>{const t=this.props.getModalState(this.props.activeModal);t&&t.type===U.PAGE&&(this.props.enteringModal?this.waitTransitionFinish(t,(()=>{requestAnimationFrame((()=>this.checkPageContentHeight()))})):requestAnimationFrame((()=>this.checkPageContentHeight())))})),c(this,"onTouchMove",(t=>{if(this.props.exitingModal)return;const e=this.props.getModalState(this.props.activeModal);return e?e.type===U.PAGE?this.onPageTouchMove(t,e):e.type===U.CARD?this.onCardTouchMove(t,e):void 0:void 0})),c(this,"onTouchEnd",(t=>{const e=this.props.getModalState(this.props.activeModal);return(null==e?void 0:e.type)===U.PAGE?this.onPageTouchEnd(t,e):(null==e?void 0:e.type)===U.CARD?this.onCardTouchEnd(t,e):void 0})),c(this,"onScroll",(t=>{var e;const n=this.props.activeModal,o=t.target;if(!n)return;const i=this.props.getModalState(n);(null==i?void 0:i.type)===U.PAGE&&(null==(e=null==i?void 0:i.contentElement)?void 0:e.contains(o))&&(i.contentScrolled=!0,i.contentScrollStopTimeout&&clearTimeout(i.contentScrollStopTimeout),i.contentScrollStopTimeout=setTimeout((()=>{i.contentScrolled&&(i.contentScrolled=!1)}),250))})),this.state={touchDown:!1,dragging:!1,modalOpenedLog:[]},this.maskElementRef=I.createRef(),this.modalRootContext={updateModalHeight:this.updateModalHeight,registerModal:t=>{var e,n=t,{id:o}=n,i=d(n,["id"]);return Object.assign(null!=(e=this.props.getModalState(o))?e:{},i)},onClose:()=>this.props.onExit(),isInsideModal:!0},this.frameIds={}}get timeout(){return this.props.platform===T.IOS?400:320}get document(){return this.props.document}get window(){return this.props.window}getModals(){return I.Children.toArray(this.props.children)}componentDidMount(){var t;null==(t=this.window)||t.addEventListener("resize",this.updateModalHeight,!1)}componentWillUnmount(){this.toggleDocumentScrolling(!0),this.window.removeEventListener("resize",this.updateModalHeight,!1)}componentDidUpdate(t){if(this.props.exitingModal&&this.props.exitingModal!==t.exitingModal&&this.closeModal(this.props.exitingModal),this.props.enteringModal&&this.props.enteringModal!==t.enteringModal){const{enteringModal:t}=this.props,e=this.props.getModalState(t);this.props.onEnter(),this.waitTransitionFinish(e,(()=>{(null==e?void 0:e.innerElement)&&(e.innerElement.style.transitionDelay=""),this.props.onEntered(t)})),(null==e?void 0:e.innerElement)&&(e.innerElement.style.transitionDelay=this.props.delayEnter?`${this.timeout}ms`:"",this.animateTranslate(e,e.translateY))}this.props.activeModal&&!t.activeModal&&(this.restoreFocusTo=this.document.activeElement),this.props.activeModal||this.props.exitingModal||!this.restoreFocusTo||(this.restoreFocusTo.focus(),this.restoreFocusTo=null),this.toggleDocumentScrolling(!this.props.activeModal&&!this.props.exitingModal)}toggleDocumentScrolling(t){this.documentScrolling!==t&&(this.documentScrolling=t,t?this.window.removeEventListener("touchmove",this.preventTouch,{passive:!1}):this.window.addEventListener("touchmove",this.preventTouch,{passive:!1}))}checkPageContentHeight(){const t=this.props.getModalState(this.props.activeModal);if((null==t?void 0:t.type)===U.PAGE&&(null==t?void 0:t.modalElement)){const e=s({},t);ht(t);const n=s({},t);let o=!1;e.expandable===n.expandable?e.translateYFrom!==n.translateYFrom&&(o=!0):o=!0,o&&this.animateTranslate(t,t.translateY)}}closeModal(t){var e,n,o;this.setState({touchDown:!1});const i=this.props.getModalState(t);if(!i)return void(t&&st(`closeActiveModal: модальное окно (страница) ${t} не существует`,"error"));this.state.modalOpenedLog.length||this.setState((e=>({modalOpenedLog:[...e.modalOpenedLog,t]})));const a=this.props.getModalState(this.props.activeModal),l=!!a&&a.type===U.PAGE,s=!!i&&i.type===U.PAGE;this.waitTransitionFinish(i,(()=>this.props.onExited(t)));const r=s&&l&&(null!=(e=i.translateY)?e:0)<=(null!=(n=null==a?void 0:a.translateYFrom)?n:0)&&!this.props.isBack?(null!=(o=null==a?void 0:a.translateYFrom)?o:0)+10:100;this.animateTranslate(i,r),a?a.id&&!this.state.modalOpenedLog.includes(a.id)&&(a.translateY=void 0,this.setState((t=>({modalOpenedLog:[...t.modalOpenedLog,a.id]})))):(this.setMaskOpacity(i,0),this.setState({modalOpenedLog:[]}),i.translateY=void 0)}onPageTouchMove(t,e){var n,o,i,a,l,s;const{shiftY:r,originalEvent:d}=t,c=d.target;if(!t.isY)return void((null==(n=this.viewportRef.current)?void 0:n.contains(c))&&d.preventDefault());if(!(null==(o=e.innerElement)?void 0:o.contains(c)))return d.preventDefault();d.stopPropagation();const{expandable:u,contentScrolled:p,collapsed:h,expanded:m}=e;if(this.state.touchDown||(e.touchStartContentScrollTop=null!=(a=null==(i=e.contentElement)?void 0:i.scrollTop)?a:0,this.setState({touchDown:!0})),!p&&(null===e.touchMovePositive&&(e.touchMovePositive=r>0),!e.expandable||h||m&&e.touchMovePositive&&0===e.touchStartContentScrollTop||(null==(l=e.headerElement)?void 0:l.contains(c)))){if(d.preventDefault(),!u&&r<0||!this.window)return;!this.state.dragging&&this.setState({dragging:!0});const t=r/this.window.innerHeight*100,n=O(t,72,.8,this.props.platform!==T.IOS);e.touchShiftYPercent=t,e.translateYCurrent=dt((null!=(s=e.translateY)?s:0)+n),this.animateTranslate(e,e.translateYCurrent),this.setMaskOpacity(e)}}onCardTouchMove(t,e){var n,o;const{originalEvent:i,shiftY:a}=t,l=i.target;if(null==(n=e.innerElement)?void 0:n.contains(l)){this.state.touchDown||this.setState({touchDown:!0,dragging:!0});const t=a/e.innerElement.offsetHeight*100,n=O(t,72,1.2,this.props.platform!==T.IOS);e.touchShiftYPercent=t,e.translateYCurrent=Math.max(0,(null!=(o=e.translateY)?o:0)+n),this.animateTranslate(e,e.translateYCurrent),this.setMaskOpacity(e)}}onPageTouchEnd(t,e){var n,o,i,a,l,s;const{startY:r,shiftY:d}=t;let c;if(e.contentScrolled=!1,e.touchMovePositive=null,this.state.dragging&&this.window){const u=(r+d)/this.window.innerHeight*100;let p=null!=(n=e.translateYCurrent)?n:0;p=dt(p+p/t.duration*240*.6*((null!=(o=e.touchShiftYPercent)?o:0)<0?-1:1)),p=100!==e.settlingHeight?rt(p,e.expandedRange)?null!=(a=null==(i=e.expandedRange)?void 0:i[0])?a:0:rt(p,e.collapsedRange)?null!=(l=e.translateYFrom)?l:0:rt(p,e.hiddenRange)?100:null!=(s=e.translateYFrom)?s:0:rt(p,[0,25])?0:100,100!==p&&u>=75&&(p=100),e.translateY=p,e.translateYCurrent=p,e.collapsed=p>0&&p<u,e.expanded=0===p,e.hidden=100===p,e.hidden&&this.props.onExit(),c=()=>{e.hidden||this.animateTranslate(e,e.translateY),this.setMaskOpacity(e)}}this.setState({touchDown:!1,dragging:!1},c)}onCardTouchEnd({duration:t},e){var n,o;let i;if(this.state.dragging){let a=null!=(n=e.translateYCurrent)?n:0;const l=a/t*240*.6*((null!=(o=e.touchShiftYPercent)?o:0)<0?-1:1);a=Math.max(0,a+l),a=a>=30?100:0,e.translateY=a,e.hidden=100===a,e.hidden&&this.props.onExit(),i=()=>{e.hidden||this.animateTranslate(e,e.translateY),this.setMaskOpacity(e)}}this.setState({touchDown:!1,dragging:!1},i)}waitTransitionFinish(t,e){var n;if($.supported){const o=()=>{var n;null==(n=null==t?void 0:t.innerElement)||n.removeEventListener($.name,o),e()};null==(n=null==t?void 0:t.innerElement)||n.addEventListener($.name,o)}else setTimeout(e,this.timeout)}animateTranslate(t,e){const n=`animateTranslateFrame${t.id}`;cancelAnimationFrame(this.frameIds[n]),this.frameIds[n]=requestAnimationFrame((()=>{var n,o;n=t.innerElement,o=`translate3d(0, ${e}%, 0)`,n&&(n.style.transform=o,n.style.webkitTransform=o)}))}setMaskOpacity(t,e=null){var n;null===e&&(null==(n=this.props.history)?void 0:n[0])!==t.id||(this.maskAnimationFrame&&cancelAnimationFrame(this.maskAnimationFrame),this.maskAnimationFrame=requestAnimationFrame((()=>{if(this.maskElementRef.current){const{translateY:n=0,translateYCurrent:o=0}=t,i=null===e?1-(o-n)/(100-n)||0:e;this.maskElementRef.current.style.opacity=_(i,0,100).toString()}})))}render(){var t;const{activeModal:e,exitingModal:n,enteringModal:o}=this.props,{touchDown:i,dragging:a}=this.state;return e||n?I.createElement(A.Provider,{value:!0},I.createElement(q.Provider,{value:this.modalRootContext},I.createElement(P,{className:k(X,(null==(t=this.props.configProvider)?void 0:t.webviewType)===Y.VKAPPS&&at,i&&k(et,"vkuiInternalModalRoot--touched"),!(!o&&!n)&&k(nt,"vkuiInternalModalRoot--switching")),onMove:this.onTouchMove,onEnd:this.onTouchEnd,onScroll:this.onScroll},I.createElement("div",{className:tt,onClick:this.props.onExit,ref:this.maskElementRef}),I.createElement("div",{className:ot,ref:this.viewportRef},this.getModals().map((t=>{const o=N(t.props),i=this.props.getModalState(o);if(o!==e&&o!==n||!i)return null;const l=s({},i),r=l.type===U.PAGE,d=`modal-${o}`;return I.createElement(V,{key:d,getRootRef:t=>{const e=this.props.getModalState(o);e&&(e.modalElement=t)},onClose:this.props.onExit,timeout:this.timeout,className:k(lt,a&&"vkuiInternalModalRoot__modal--dragging",r&&l.expandable&&"vkuiInternalModalRoot__modal--expandable",r&&l.collapsed&&"vkuiInternalModalRoot__modal--collapsed"),restoreFocus:!1},t)})))))):null}}const ut=function(t,e,n){return function(o){const i=I.useContext(e);return I.createElement(t,r(s({},o),{[n]:i}))}}((pt=R(function(t=C){return function(e){return function(n){const o=Q(n.activeModal,n.children,n.onOpen,n.onOpened,n.onClose,n.onClosed,t);return I.createElement(e,s(s({},n),o))}}}((function(t){switch(t.type){case U.PAGE:return t.settlingHeight=t.settlingHeight||75,ht(t);case U.CARD:return function(t){t.translateY=0}(t)}}))(ct)),function(t){const{platform:e}=x();return I.createElement(pt,r(s({},t),{platform:e}))}),w,"configProvider");var pt;function ht(t){var e,n,o,i,a,l,s;const{contentElement:r}=t,d=(null==r?void 0:r.firstElementChild).offsetHeight;let c=t.translateY;t.expandable=d>(null!=(e=null==r?void 0:r.clientHeight)?e:0)||100===t.settlingHeight||t.expanded;let u,p,h,m,v,g=!1,f=!1;if(t.expandable){u=100-(null!=(n=t.settlingHeight)?n:0);const e=u/2,o=100-u;h=[0,e],m=[e,u+o/4],v=[u+o/4,100],g=u>0,f=u<=0,p=u}else{u=100-(d+(null!=(i=null==(o=t.headerElement)?void 0:o.offsetHeight)?i:0))/(null!=(s=null==(l=null==(a=t.innerElement)?void 0:a.parentElement)?void 0:l.offsetHeight)?s:0)*100,p=u,h=[p,p+25],m=[p+25,p+25],v=[p+25,p+100]}(t.expandable&&p>(null!=c?c:100)||100===t.settlingHeight)&&(p=0),0===p&&(f=!0,g=!1),t.expandedRange=h,t.collapsedRange=m,t.hiddenRange=v,t.translateY=p,t.translateYFrom=u,t.collapsed=g,t.expanded=f}const mt=({activeModal:t,children:e,onOpen:n,onOpened:o,onClose:i,onClosed:a})=>{const l=I.useRef(null),s=I.useRef(void 0),r=I.useRef(void 0),{document:c}=m(),{webviewType:u,platform:p}=x(),{activeModal:h,exitingModal:v,onExit:g,getModalState:f,enteringModal:M,onEnter:E,onEntered:y,onExited:S,history:w,delayEnter:R}=Q(t,e,n,o,i,a,C),{waitTransitionFinish:O}=B(),A=z({exitingModal:v,enteringModal:M,activeModal:h}),P=F({updateModalHeight:()=>{},registerModal:t=>{var e,n=t,{id:o}=n,i=d(n,["id"]);return Object.assign(null!=(e=f(o))?e:{},i)},onClose:g,isInsideModal:!0}),b=p===T.IOS?400:320,D=I.Children.toArray(e),H=(t,e)=>{(null==t?void 0:t.innerElement)&&(t.innerElement.style.transition="",t.innerElement.style.transitionDelay=e&&R?`${b}ms`:"",t.innerElement.style.opacity=e?"1":"0")},j=t=>{const e=f(t);e&&(h?S(t):requestAnimationFrame((()=>{O(null==e?void 0:e.innerElement,(()=>S(t)),b),H(e,!1),((t,e=null)=>{null===e&&(null==w?void 0:w[0])!==t.id||(s.current&&cancelAnimationFrame(s.current),s.current=requestAnimationFrame((()=>{if(l.current){const{translateY:n=0,translateYCurrent:o=0}=t,i=null===e?1-(o-n)/(100-n)||0:e;l.current.style.opacity=_(i,0,100).toString()}})))})(e,0)})))};return I.useEffect((()=>{var t;A&&(v&&v!==A.exitingModal&&j(v),M&&M!==A.enteringModal&&(()=>{if(!M||!A)return;const t=f(M);E(),A.exitingModal?((null==t?void 0:t.innerElement)&&(t.innerElement.style.transition="none",t.innerElement.style.opacity="1"),y(M)):requestAnimationFrame((()=>{M==M&&(O(null==t?void 0:t.innerElement,(()=>y(M)),b),H(t,!0))}))})(),h&&!A.activeModal&&(r.current=null!=(t=null==c?void 0:c.activeElement)?t:void 0),h||v||!r.current||(r.current.focus(),r.current=void 0))})),h||v?I.createElement(q.Provider,{value:P},I.createElement("div",{className:k(X,u===Y.VKAPPS&&at,it)},I.createElement("div",{className:tt,ref:l,onClick:g}),I.createElement("div",{className:ot},D.map((t=>{const e=N(t.props);if(e!==h&&e!==v)return null;const n=`modal-${e}`;return I.createElement(V,{restoreFocus:!1,onClose:g,timeout:b,key:n,className:lt},t)}))))):null},vt=t=>{const{isDesktop:e}=L();b(!!t.activeModal);const n=e?mt:ut;return I.createElement(n,t)},gt=I.lazy((()=>u((()=>import("./FullstackModal-bca1fd38.js")),["assets/FullstackModal-bca1fd38.js","assets/index-8e849d0e.js","assets/react-37698f52.js","assets/index-3a72483a.css","assets/AppWrapper-709c38ee.js","assets/AppWrapper-ceaaef78.css","assets/App-7db3437f.js","assets/App-cafd1bcd.css","assets/useWaitTransitionFinish-92d1af88.js","assets/PanelHeaderButton-2c3d012a.js","assets/PanelHeaderButton-412d0c61.css","assets/Subhead-4ef76af3.js","assets/Subhead-1c6aa1fb.css","assets/FullstackModal-8e201c1c.css"]))),ft=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const t=D(),{modal:e}=G();return p.jsx(H,{id:"test",children:p.jsx(vt,{activeModal:e,onClose:()=>t.hideModal(),children:p.jsx(gt,{id:j})})})}},Symbol.toStringTag,{value:"Module"}));export{U as M,ft as i};
