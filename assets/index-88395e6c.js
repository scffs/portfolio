var t=Object.defineProperty,e=Object.defineProperties,n=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,s=(e,n,o)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[n]=o,l=(t,e)=>{for(var n in e||(e={}))i.call(e,n)&&s(t,n,e[n]);if(o)for(var n of o(e))a.call(e,n)&&s(t,n,e[n]);return t},r=(t,o)=>e(t,n(o)),d=(t,e)=>{var n={};for(var s in t)i.call(t,s)&&e.indexOf(s)<0&&(n[s]=t[s]);if(null!=t&&o)for(var s of o(t))e.indexOf(s)<0&&a.call(t,s)&&(n[s]=t[s]);return n},c=(t,e,n)=>(s(t,"symbol"!=typeof e?e+"":e,n),n);import{_ as u,j as p}from"./index-a570bfc0.js";import{X as h,A as m,d as v,Z as g,$ as f,i as M,h as E,t as y,C as x,a0 as S,P as C,a1 as w,a2 as T,a3 as O,a4 as R,c as P,f as _,r as k,a5 as A,F as Y,H as b,a6 as F}from"./AppWrapper-9701c826.js";import{r as H}from"./react-37698f52.js";import{b as D,g as j,c as I,d as L,e as G,t as $,m as q,f as z,M as N,a as B}from"./App-33f3984a.js";import{g as W,t as X,u as U,a as V}from"./useWaitTransitionFinish-e87f379a.js";import{F as Z,w as J}from"./FocusTrap-39586b73.js";function K(t){return"function"==typeof t}function Q(t,e){return null!=t?t:e}const tt=()=>{const{viewWidth:t,viewHeight:e,sizeX:n,sizeY:o,hasPointer:i,hasHover:a}=H.useContext(m),s=v(),l=D(),[[r,d],c]=H.useState((()=>[Q(t,j(l)),Q(e,I(l))])),u=H.useMemo((()=>{const l=Q(i,g),c=Q(a,f),u=Q(t,r),p=Q(e,d);return{viewWidth:u,viewHeight:p,sizeX:Q(n,L(u)),sizeY:Q(o,G(u,p,l)),hasPointer:l,hasHover:c,isDesktop:$(u,p,l,s)}}),[r,d,t,e,n,o,i,a,s]);return H.useEffect((()=>{const n=()=>{c((n=>{const o=Q(t,j(l)),i=Q(e,I(l)),[a,s]=n;return a!==o||s!==i?[o,i]:n}))};return t||[l.desktopPlus,l.tablet,l.smallTablet,l.mobile].forEach((t=>q(t,n))),e||[l.mediumHeight,l.mobileLandscapeHeight].forEach((t=>q(t,n))),()=>{[l.desktopPlus,l.tablet,l.smallTablet,l.mobile,l.mediumHeight,l.mobileLandscapeHeight].forEach((t=>z(t,n)))}}),[l,t,e]),u};var et,nt;function ot(t,e){if("setActive"===e.type&&e.id!==t.activeModal){const n=e.id,o=t.exitingModal||t.activeModal;let i=t.history?[...t.history]:[];const a=Boolean(n&&i.includes(n));return null===n?i=[]:a?i=i.splice(0,i.indexOf(n)+1):i.push(n),{activeModal:n,enteringModal:null,exitingModal:o,history:i,isBack:a}}return"entered"===e.type&&e.id===t.enteringModal?r(l({},t),{enteringModal:null}):"exited"===e.type&&e.id===t.exitingModal?r(l({},t),{exitingModal:null}):"inited"===e.type&&e.id===t.activeModal?r(l({},t),{enteringModal:e.id}):t}function it(t,e,n=y,o=y,i=y,a=y,s=y){const d=H.useRef({}).current;(function(t){return H.Children.toArray(t)})(e).forEach((t=>{const e=t.props,n=W(e),o=void 0!==n&&d[n]||{id:null!=n?n:null};o.onOpen=t.props.onOpen,o.onOpened=t.props.onOpened,o.onClose=t.props.onClose,o.onClosed=t.props.onClosed,"number"==typeof e.settlingHeight&&(o.settlingHeight=e.settlingHeight),null!==o.id&&(d[o.id]=o)}));const c=t&&!d[t]?null:t,[u,p]=H.useReducer(ot,{activeModal:c,enteringModal:null,exitingModal:null,history:c?[c]:[],isBack:!1});E((()=>{p({type:"setActive",id:null!=c?c:null})}),[t]),E((()=>{u.activeModal&&(s(d[u.activeModal]),p({type:"inited",id:u.activeModal}))}),[u.activeModal]);const h=t=>{var e;return null!=t&&(null==(e=d[t])?void 0:e.type)===et.CARD},m=H.useCallback((t=>{if(t){const e=d[t];K(e.onOpened)?e.onOpened():K(o)&&o(t)}p({type:"entered",id:t})}),[d,o]),v=H.useCallback((t=>{if(t){const e=d[t];K(e.onClosed)?e.onClosed():K(a)&&a(t)}p({type:"exited",id:t})}),[d,a]),g=Boolean(u.exitingModal&&(h(t)||h(u.exitingModal))),f=H.useCallback((t=>t?d[t]:void 0),[d]);return r(l({onEnter:function(){const t=u.activeModal&&d[u.activeModal];t&&(K(t.onOpen)?t.onOpen():K(n)&&t.id&&n(t.id))},onEntered:m,onExit:function(){const t=u.activeModal&&d[u.activeModal];t&&(K(t.onClose)?t.onClose():K(i)&&t.id&&i(t.id))},onExited:v},u),{delayEnter:g,getModalState:f})}(nt=et||(et={})).PAGE="page",nt.CARD="card";const at="_ModalRoot_j6pv1_1",st="_ModalRoot__mask_j6pv1_6",lt="_ModalRoot--touched_j6pv1_22",rt="_ModalRoot--switching_j6pv1_26",dt="_ModalRoot__viewport_j6pv1_31",ct="_ModalRoot--desktop_j6pv1_40",ut="_ModalRoot--hasCustomPanelHeaderAfterSlot_j6pv1_44",pt="_ModalRoot__modal_j6pv1_50",ht=J("ModalRoot");function mt(t,e){return!!e&&(t>=e[0]&&t<=e[1])}function vt(t){return T(t,0,98)}class gt extends H.Component{constructor(t){super(t),c(this,"documentScrolling",!1),c(this,"maskElementRef"),c(this,"viewportRef",H.createRef()),c(this,"maskAnimationFrame"),c(this,"modalRootContext"),c(this,"frameIds"),c(this,"restoreFocusTo"),c(this,"preventTouch",(t=>{if(!t)return!1;for(;t.originalEvent;)t=t.originalEvent;return t.preventDefault&&t.preventDefault(),!1})),c(this,"updateModalHeight",(()=>{const t=this.props.getModalState(this.props.activeModal);t&&t.type===et.PAGE&&(this.props.enteringModal?this.waitTransitionFinish(t,(()=>{requestAnimationFrame((()=>this.checkPageContentHeight()))})):requestAnimationFrame((()=>this.checkPageContentHeight())))})),c(this,"onTouchMove",(t=>{if(this.props.exitingModal)return;const e=this.props.getModalState(this.props.activeModal);return e?e.type===et.PAGE?this.onPageTouchMove(t,e):e.type===et.CARD?this.onCardTouchMove(t,e):void 0:void 0})),c(this,"onTouchEnd",(t=>{const e=this.props.getModalState(this.props.activeModal);return(null==e?void 0:e.type)===et.PAGE?this.onPageTouchEnd(t,e):(null==e?void 0:e.type)===et.CARD?this.onCardTouchEnd(t,e):void 0})),c(this,"onScroll",(t=>{var e;const n=this.props.activeModal,o=t.target;if(!n)return;const i=this.props.getModalState(n);(null==i?void 0:i.type)===et.PAGE&&(null==(e=null==i?void 0:i.contentElement)?void 0:e.contains(o))&&(i.contentScrolled=!0,i.contentScrollStopTimeout&&clearTimeout(i.contentScrollStopTimeout),i.contentScrollStopTimeout=setTimeout((()=>{i.contentScrolled&&(i.contentScrolled=!1)}),250))})),this.state={touchDown:!1,dragging:!1,modalOpenedLog:[]},this.maskElementRef=H.createRef(),this.modalRootContext={updateModalHeight:this.updateModalHeight,registerModal:t=>{var e,n=t,{id:o}=n,i=d(n,["id"]);return Object.assign(null!=(e=this.props.getModalState(o))?e:{},i)},onClose:()=>this.props.onExit(),isInsideModal:!0},this.frameIds={}}get timeout(){return this.props.platform===C.IOS?400:320}get document(){return this.props.document}get window(){return this.props.window}getModals(){return H.Children.toArray(this.props.children)}componentDidMount(){var t;null==(t=this.window)||t.addEventListener("resize",this.updateModalHeight,!1)}componentWillUnmount(){this.toggleDocumentScrolling(!0),this.window.removeEventListener("resize",this.updateModalHeight,!1)}componentDidUpdate(t){if(this.props.exitingModal&&this.props.exitingModal!==t.exitingModal&&this.closeModal(this.props.exitingModal),this.props.enteringModal&&this.props.enteringModal!==t.enteringModal){const{enteringModal:t}=this.props,e=this.props.getModalState(t);this.props.onEnter(),this.waitTransitionFinish(e,(()=>{(null==e?void 0:e.innerElement)&&(e.innerElement.style.transitionDelay=""),this.props.onEntered(t)})),(null==e?void 0:e.innerElement)&&(e.innerElement.style.transitionDelay=this.props.delayEnter?`${this.timeout}ms`:"",this.animateTranslate(e,e.translateY),this.setMaskOpacity(e,1))}this.props.activeModal&&!t.activeModal&&(this.restoreFocusTo=this.document.activeElement),this.props.activeModal||this.props.exitingModal||!this.restoreFocusTo||(this.restoreFocusTo.focus(),this.restoreFocusTo=null),this.toggleDocumentScrolling(!this.props.activeModal&&!this.props.exitingModal)}toggleDocumentScrolling(t){this.documentScrolling!==t&&(this.documentScrolling=t,t?this.window.removeEventListener("touchmove",this.preventTouch,{passive:!1}):this.window.addEventListener("touchmove",this.preventTouch,{passive:!1}))}checkPageContentHeight(){const t=this.props.getModalState(this.props.activeModal);if((null==t?void 0:t.type)===et.PAGE&&(null==t?void 0:t.modalElement)){const e=l({},t);Et(t);const n=l({},t);let o=!1;e.expandable===n.expandable?e.translateYFrom!==n.translateYFrom&&(o=!0):o=!0,o&&this.animateTranslate(t,t.translateY)}}closeModal(t){var e,n,o;this.setState({touchDown:!1});const i=this.props.getModalState(t);if(!i)return void(t&&ht(`closeActiveModal: модальное окно (страница) ${t} не существует`,"error"));this.state.modalOpenedLog.length||this.setState((e=>({modalOpenedLog:[...e.modalOpenedLog,t]})));const a=this.props.getModalState(this.props.activeModal),s=!!a&&a.type===et.PAGE,l=!!i&&i.type===et.PAGE;this.waitTransitionFinish(i,(()=>this.props.onExited(t)));const r=l&&s&&(null!=(e=i.translateY)?e:0)<=(null!=(n=null==a?void 0:a.translateYFrom)?n:0)&&!this.props.isBack?(null!=(o=null==a?void 0:a.translateYFrom)?o:0)+10:100;this.animateTranslate(i,r),a?a.id&&!this.state.modalOpenedLog.includes(a.id)&&(a.translateY=void 0,this.setState((t=>({modalOpenedLog:[...t.modalOpenedLog,a.id]})))):(this.setMaskOpacity(i,0),this.setState({modalOpenedLog:[]}),i.translateY=void 0)}onPageTouchMove(t,e){var n,o,i,a,s,l;const{shiftY:r,originalEvent:d}=t,c=d.target;if(!t.isY)return void((null==(n=this.viewportRef.current)?void 0:n.contains(c))&&d.preventDefault());if(!(null==(o=e.innerElement)?void 0:o.contains(c)))return d.preventDefault();d.stopPropagation();const{expandable:u,contentScrolled:p,collapsed:h,expanded:m}=e;if(this.state.touchDown||(e.touchStartContentScrollTop=null!=(a=null==(i=e.contentElement)?void 0:i.scrollTop)?a:0,this.setState({touchDown:!0})),!p&&(null===e.touchMovePositive&&(e.touchMovePositive=r>0),!e.expandable||h||m&&e.touchMovePositive&&0===e.touchStartContentScrollTop||(null==(s=e.headerElement)?void 0:s.contains(c)))){if(d.preventDefault(),!u&&r<0||!this.window)return;!this.state.dragging&&this.setState({dragging:!0});const t=r/this.window.innerHeight*100,n=w(t,72,.8,this.props.platform!==C.IOS);e.touchShiftYPercent=t,e.translateYCurrent=vt((null!=(l=e.translateY)?l:0)+n),this.animateTranslate(e,e.translateYCurrent),this.setMaskOpacity(e)}}onCardTouchMove(t,e){var n,o;const{originalEvent:i,shiftY:a}=t,s=i.target;if(null==(n=e.innerElement)?void 0:n.contains(s)){this.state.touchDown||this.setState({touchDown:!0,dragging:!0});const t=a/e.innerElement.offsetHeight*100,n=w(t,72,1.2,this.props.platform!==C.IOS);e.touchShiftYPercent=t,e.translateYCurrent=Math.max(0,(null!=(o=e.translateY)?o:0)+n),this.animateTranslate(e,e.translateYCurrent),this.setMaskOpacity(e)}}onPageTouchEnd(t,e){var n,o,i,a,s,l;const{startY:r,shiftY:d}=t;let c;if(e.contentScrolled=!1,e.touchMovePositive=null,this.state.dragging&&this.window){const u=(r+d)/this.window.innerHeight*100;let p=null!=(n=e.translateYCurrent)?n:0;p=vt(p+p/t.duration*240*.6*((null!=(o=e.touchShiftYPercent)?o:0)<0?-1:1)),p=100!==e.settlingHeight?mt(p,e.expandedRange)?null!=(a=null==(i=e.expandedRange)?void 0:i[0])?a:0:mt(p,e.collapsedRange)?null!=(s=e.translateYFrom)?s:0:mt(p,e.hiddenRange)?100:null!=(l=e.translateYFrom)?l:0:mt(p,[0,25])?0:100,100!==p&&u>=75&&(p=100),e.translateY=p,e.translateYCurrent=p,e.collapsed=p>0&&p<u,e.expanded=0===p,e.hidden=100===p,e.hidden&&this.props.onExit(),c=()=>{e.hidden||this.animateTranslate(e,e.translateY),this.setMaskOpacity(e)}}this.setState({touchDown:!1,dragging:!1},c)}onCardTouchEnd({duration:t},e){var n,o;let i;if(this.state.dragging){let a=null!=(n=e.translateYCurrent)?n:0;const s=a/t*240*.6*((null!=(o=e.touchShiftYPercent)?o:0)<0?-1:1);a=Math.max(0,a+s),a=a>=30?100:0,e.translateY=a,e.hidden=100===a,e.hidden&&this.props.onExit(),i=()=>{e.hidden||this.animateTranslate(e,e.translateY),this.setMaskOpacity(e)}}this.setState({touchDown:!1,dragging:!1},i)}waitTransitionFinish(t,e){var n;if(X.supported){const o=()=>{var n;null==(n=null==t?void 0:t.innerElement)||n.removeEventListener(X.name,o),e()};null==(n=null==t?void 0:t.innerElement)||n.addEventListener(X.name,o)}else setTimeout(e,this.timeout)}animateTranslate(t,e){const n=`animateTranslateFrame${t.id}`;cancelAnimationFrame(this.frameIds[n]),this.frameIds[n]=requestAnimationFrame((()=>{var n,o;n=t.innerElement,o=`translate3d(0, ${e}%, 0)`,n&&(n.style.transform=o,n.style.webkitTransform=o)}))}setMaskOpacity(t,e=null){var n;null===e&&(null==(n=this.props.history)?void 0:n[0])!==t.id||(this.maskAnimationFrame&&cancelAnimationFrame(this.maskAnimationFrame),this.maskAnimationFrame=requestAnimationFrame((()=>{if(this.maskElementRef.current){const{translateY:n=0,translateYCurrent:o=0}=t,i=null===e?1-(o-n)/(100-n)||0:e;this.maskElementRef.current.style.opacity=T(i,0,100).toString(),this.maskElementRef.current.style.transitionDelay=i&&this.props.delayEnter?`${this.timeout}ms`:""}})))}render(){var t;const{activeModal:e,exitingModal:n,enteringModal:o}=this.props,{touchDown:i,dragging:a}=this.state;return e||n?H.createElement(O.Provider,{value:!0},H.createElement(N.Provider,{value:this.modalRootContext},H.createElement(R,{className:P(at,(null==(t=this.props.configProvider)?void 0:t.hasCustomPanelHeaderAfter)&&ut,i&&P(lt,"vkuiInternalModalRoot--touched"),!(!o&&!n)&&P(rt,"vkuiInternalModalRoot--switching")),onMove:this.onTouchMove,onEnd:this.onTouchEnd,onScroll:this.onScroll},H.createElement("div",{className:st,onClick:this.props.onExit,ref:this.maskElementRef}),H.createElement("div",{className:dt,ref:this.viewportRef},this.getModals().map((t=>{const o=W(t.props),i=this.props.getModalState(o);if(o!==e&&o!==n||!i)return null;const s=l({},i),r=s.type===et.PAGE,d=`modal-${o}`;return H.createElement(Z,{key:d,getRootRef:t=>{const e=this.props.getModalState(o);e&&(e.modalElement=t)},onClose:this.props.onExit,timeout:this.timeout,className:P(pt,a&&"vkuiInternalModalRoot__modal--dragging",r&&s.expandable&&"vkuiInternalModalRoot__modal--expandable",r&&s.collapsed&&"vkuiInternalModalRoot__modal--collapsed"),restoreFocus:!1},t)})))))):null}}const ft=function(t,e,n){return function(o){const i=H.useContext(e);return H.createElement(t,r(l({},o),{[n]:i}))}}((Mt=S(function(t=y){return function(e){return function(n){const o=it(n.activeModal,n.children,n.onOpen,n.onOpened,n.onClose,n.onClosed,t);return H.createElement(e,l(l({},n),o))}}}((function(t){switch(t.type){case et.PAGE:return t.settlingHeight=t.settlingHeight||75,Et(t);case et.CARD:return function(t){t.translateY=0}(t)}}))(gt)),function(t){const{platform:e}=M();return H.createElement(Mt,r(l({},t),{platform:e}))}),x,"configProvider");var Mt;function Et(t){var e,n,o,i,a,s,l;const{contentElement:r,bottomInset:d}=t,c=(null==r?void 0:r.firstElementChild).scrollHeight+((null==d?void 0:d.offsetHeight)||0);let u=t.translateY;t.expandable=c>(null!=(e=null==r?void 0:r.clientHeight)?e:0)||100===t.settlingHeight||t.expanded;let p,h,m,v,g,f=!1,M=!1;if(t.expandable){p=100-(null!=(n=t.settlingHeight)?n:0);const e=p/2,o=100-p;m=[0,e],v=[e,p+o/4],g=[p+o/4,100],f=p>0,M=p<=0,h=p}else{p=100-(c+(null!=(i=null==(o=t.headerElement)?void 0:o.offsetHeight)?i:0))/(null!=(l=null==(s=null==(a=t.innerElement)?void 0:a.parentElement)?void 0:s.offsetHeight)?l:0)*100,h=p,m=[h,h+25],v=[h+25,h+25],g=[h+25,h+100]}(t.expandable&&h>(null!=u?u:100)||100===t.settlingHeight)&&(h=0),0===h&&(M=!0,f=!1),t.expandedRange=m,t.collapsedRange=v,t.hiddenRange=g,t.translateY=h,t.translateYFrom=p,t.collapsed=f,t.expanded=M}const yt=({activeModal:t,children:e,onOpen:n,onOpened:o,onClose:i,onClosed:a})=>{const s=H.useRef(null),l=H.useRef(void 0),r=H.useRef(void 0),{document:c}=_(),{hasCustomPanelHeaderAfter:u,platform:p}=M(),{activeModal:h,exitingModal:m,onExit:v,getModalState:g,enteringModal:f,onEnter:E,onEntered:x,onExited:S,history:w,delayEnter:O}=it(t,e,n,o,i,a,y),{waitTransitionFinish:R}=U(),A=V({exitingModal:m,enteringModal:f,activeModal:h}),Y=k({updateModalHeight:()=>{},registerModal:t=>{var e,n=t,{id:o}=n,i=d(n,["id"]);return Object.assign(null!=(e=g(o))?e:{},i)},onClose:v,isInsideModal:!0}),b=p===C.IOS?400:320,F=H.Children.toArray(e),D=(t,e)=>{(null==t?void 0:t.innerElement)&&(t.innerElement.style.transition="",t.innerElement.style.transitionDelay=e&&O?`${b}ms`:"",t.innerElement.style.opacity=e?"1":"0")},j=(t,e=null)=>{null===e&&(null==w?void 0:w[0])!==t.id||(l.current&&cancelAnimationFrame(l.current),l.current=requestAnimationFrame((()=>{if(s.current){const{translateY:n=0,translateYCurrent:o=0}=t,i=null===e?1-(o-n)/(100-n)||0:e;s.current.style.opacity=T(i,0,100).toString()}})))};return H.useEffect((()=>{var t;A&&(m&&m!==A.exitingModal&&(t=>{const e=g(t);e&&(h?S(t):requestAnimationFrame((()=>{R(null==e?void 0:e.innerElement,(()=>S(t)),b),D(e,!1),j(e,0)})))})(m),f&&f!==A.enteringModal&&(()=>{if(!f||!A)return;const t=g(f);E(),A.exitingModal?(requestAnimationFrame((()=>{(null==t?void 0:t.innerElement)&&(t.innerElement.style.transition="none",t.innerElement.style.opacity="1",j(t,1))})),x(f)):requestAnimationFrame((()=>{f==f&&(R(null==t?void 0:t.innerElement,(()=>x(f)),b),D(t,!0),t&&j(t,1))}))})(),h&&!A.activeModal&&(r.current=null!=(t=null==c?void 0:c.activeElement)?t:void 0),h||m||!r.current||(r.current.focus(),r.current=void 0))})),h||m?H.createElement(N.Provider,{value:Y},H.createElement("div",{className:P(at,u&&ut,ct)},H.createElement("div",{className:st,ref:s,onClick:v}),H.createElement("div",{className:dt},F.map((t=>{const e=W(t.props);if(e!==h&&e!==m)return null;const n=`modal-${e}`;return H.createElement(Z,{restoreFocus:!1,onClose:v,timeout:b,key:n,className:pt},t)}))))):null},xt=t=>{const{isDesktop:e}=tt();A(!!t.activeModal);const n=e?yt:ft;return H.createElement(n,t)},St=H.lazy((()=>u((()=>import("./FullstackModal-f32117ae.js")),["assets/FullstackModal-f32117ae.js","assets/index-a570bfc0.js","assets/react-37698f52.js","assets/index-2e2e5bc2.css","assets/AppWrapper-9701c826.js","assets/AppWrapper-8c195567.css","assets/useWaitTransitionFinish-e87f379a.js","assets/PanelHeaderButton-5dd34c4f.js","assets/App-33f3984a.js","assets/App-b899851c.css","assets/PanelHeaderButton-412d0c61.css","assets/Subhead-d963e956.js","assets/Subhead-1c6aa1fb.css","assets/FocusTrap-39586b73.js","assets/FullstackModal-f9a1cff3.css"]))),Ct=Object.freeze(Object.defineProperty({__proto__:null,default:()=>{const t=Y(),{modal:e}=B();return p.jsx(b,{id:"test",children:p.jsx(xt,{activeModal:e,onClose:()=>t.hideModal(),children:p.jsx(St,{id:F})})})}},Symbol.toStringTag,{value:"Module"}));export{et as M,Ct as i,tt as u};
